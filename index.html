<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schafkopf Abrechnung Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/dist/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white font-sans">
    <div id="root">
        <div class="flex items-center justify-center min-h-screen">
            <p class="text-xl animate-pulse">Lade Schafkopf-App...</p>
        </div>
    </div>

    <script type="text/babel">
        // Zugriff auf Recharts Komponenten
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;
        const { useState, useEffect } = React;

        function SchafkopfApp() {
            const [players, setPlayers] = useState([]);
            const [newPlayerName, setNewPlayerName] = useState('');
            const [gameHistory, setGameHistory] = useState([]);
            const [selectedWinners, setSelectedWinners] = useState([]);
            const [selectedLosers, setSelectedLosers] = useState([]);
            const [pointValue, setPointValue] = useState('');
            const [gameMode, setGameMode] = useState('normal');

            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

            // Daten beim Start laden
            useEffect(() => {
                const savedPlayers = localStorage.getItem('sk_players');
                const savedHistory = localStorage.getItem('sk_history');
                if (savedPlayers) setPlayers(JSON.parse(savedPlayers));
                if (savedHistory) setGameHistory(JSON.parse(savedHistory));
            }, []);

            // Speichern bei Änderungen
            useEffect(() => {
                if (players.length > 0) localStorage.setItem('sk_players', JSON.stringify(players));
                localStorage.setItem('sk_history', JSON.stringify(gameHistory));
            }, [players, gameHistory]);

            const addPlayer = () => {
                if (newPlayerName.trim() && players.length < 6) {
                    setPlayers([...players, { 
                        name: newPlayerName.trim(), 
                        points: 0, 
                        handsPlayed: 0, 
                        history: [{ round: gameHistory.length, points: 0 }] 
                    }]);
                    setNewPlayerName('');
                }
            };

            const toggleWinner = (i) => {
                const max = gameMode === 'solo' ? 3 : 2;
                if (selectedWinners.includes(i)) setSelectedWinners(selectedWinners.filter(x => x !== i));
                else if (selectedWinners.length < max && !selectedLosers.includes(i)) setSelectedWinners([...selectedWinners, i]);
            };

            const toggleLoser = (i) => {
                const max = gameMode === 'solo' ? 1 : 2;
                if (selectedLosers.includes(i)) setSelectedLosers(selectedLosers.filter(x => x !== i));
                else if (selectedLosers.length < max && !selectedWinners.includes(i)) setSelectedLosers([...selectedLosers, i]);
            };

            const recordGame = () => {
                const points = parseFloat(pointValue);
                if (!points || selectedWinners.length === 0) return alert("Punkte eingeben & Gewinner wählen!");

                const newPlayers = players.map((p, i) => {
                    let pPoints = p.points;
                    let pHands = p.handsPlayed;
                    if (selectedWinners.includes(i)) { pPoints += points; pHands++; }
                    if (selectedLosers.includes(i)) { pPoints -= points; pHands++; }
                    
                    return {
                        ...p,
                        points: pPoints,
                        handsPlayed: pHands,
                        history: [...p.history, { round: gameHistory.length + 1, points: pPoints }]
                    };
                });

                const game = {
                    winners: selectedWinners.map(i => players[i].name),
                    losers: selectedLosers.map(i => players[i].name),
                    points: points,
                    mode: gameMode,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };

                setPlayers(newPlayers);
                setGameHistory([...gameHistory, game]);
                setSelectedWinners([]);
                setSelectedLosers([]);
                setPointValue('');
            };

            const getChartData = () => {
                const rounds = Array.from({ length: gameHistory.length + 1 }, (_, i) => ({ name: i }));
                players.forEach(p => {
                    p.history.forEach(h => {
                        if (rounds[h.round]) rounds[h.round][p.name] = h.points;
                    });
                });
                return rounds;
            };

            return (
                <div className="max-w-4xl mx-auto p-4 space-y-6">
                    <header className="flex justify-between items-center py-6 border-b border-white/10">
                        <h1 class="text-3xl font-black text-green-400">Schafkopf PRO</h1>
                        <button onClick={() => {if(confirm('Alles löschen?')){localStorage.clear(); location.reload();}}} className="text-red-500 text-sm">Reset</button>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Spieler Setup */}
                        <section className="bg-slate-800 p-6 rounded-2xl shadow-xl">
                            <h2 className="text-xl font-bold mb-4">Spieler ({players.length}/6)</h2>
                            <div className="flex gap-2 mb-4">
                                <input className="flex-1 p-2 rounded bg-slate-700 border-none" value={newPlayerName} onChange={e => setNewPlayerName(e.target.value)} placeholder="Name..." />
                                <button onClick={addPlayer} className="bg-green-600 px-4 rounded font-bold">+</button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {players.map((p, i) => (
                                    <div key={i} className="bg-slate-700 px-3 py-1 rounded-full flex justify-between gap-4">
                                        <span>{p.name}</span>
                                        <span className="font-bold">{(p.points/100).toFixed(2)}€</span>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* Spiel Eingabe */}
                        <section className="bg-slate-800 p-6 rounded-2xl shadow-xl">
                            <h2 className="text-xl font-bold mb-4">Neues Spiel</h2>
                            <div className="flex gap-2 mb-4">
                                <button onClick={() => setGameMode('normal')} className={`flex-1 p-2 rounded ${gameMode === 'normal' ? 'bg-green-600' : 'bg-slate-700'}`}>Normal</button>
                                <button onClick={() => setGameMode('solo')} className={`flex-1 p-2 rounded ${gameMode === 'solo' ? 'bg-purple-600' : 'bg-slate-700'}`}>Solo</button>
                            </div>
                            <div className="space-y-4">
                                <p className="text-xs text-gray-400">GEWINNER (Tippen):</p>
                                <div className="flex flex-wrap gap-2">
                                    {players.map((p, i) => (
                                        <button key={i} onClick={() => toggleWinner(i)} className={`px-3 py-1 rounded border ${selectedWinners.includes(i) ? 'bg-green-600 border-green-400' : 'border-slate-600'}`}>{p.name}</button>
                                    ))}
                                </div>
                                <input type="number" className="w-full p-3 rounded bg-slate-700 text-xl font-bold" value={pointValue} onChange={e => setPointValue(e.target.value)} placeholder="Cent (z.B. 20)" />
                                <button onClick={recordGame} className="w-full bg-green-500 p-4 rounded-xl font-black text-slate-900">EINTRAGEN</button>
                            </div>
                        </section>
                    </div>

                    {/* Chart */}
                    {gameHistory.length > 0 && (
                        <section className="bg-slate-800 p-6 rounded-2xl h-80 shadow-xl">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={getChartData()}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#444" />
                                    <XAxis dataKey="name" stroke="#888" />
                                    <YAxis stroke="#888" />
                                    <Tooltip contentStyle={{backgroundColor: '#1e293b', border: 'none'}} />
                                    <Legend />
                                    {players.map((p, i) => (
                                        <Line key={p.name} type="monotone" dataKey={p.name} stroke={colors[i % colors.length]} strokeWidth={3} dot={false} />
                                    ))}
                                </LineChart>
                            </ResponsiveContainer>
                        </section>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SchafkopfApp />);
    </script>
</body>
</html>
