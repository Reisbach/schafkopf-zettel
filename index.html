<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schafkopf Abrechnung</title>

  <!-- React 18 -->
  <script defer src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Recharts (UMD, stabil ohne Polling) -->
  <script defer src="https://unpkg.com/recharts@2.12.7/dist/Recharts.js"></script>

  <!-- Babel -->
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white min-h-screen">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    function SchafkopfApp() {
      const [players, setPlayers] = useState([]);
      const [newPlayerName, setNewPlayerName] = useState('');
      const [gameHistory, setGameHistory] = useState([]);
      const [winners, setWinners] = useState([]);
      const [losers, setLosers] = useState([]);
      const [pointValue, setPointValue] = useState('10');
      const [gameMode, setGameMode] = useState('normal');

      // Load
      useEffect(() => {
        const p = localStorage.getItem('sk_players_v2');
        const h = localStorage.getItem('sk_history_v2');
        if (p) setPlayers(JSON.parse(p));
        if (h) setGameHistory(JSON.parse(h));
      }, []);

      // Save
      useEffect(() => {
        localStorage.setItem('sk_players_v2', JSON.stringify(players));
        localStorage.setItem('sk_history_v2', JSON.stringify(gameHistory));
      }, [players, gameHistory]);

      const addPlayer = () => {
        if (!newPlayerName.trim() || players.length >= 6) return;
        setPlayers([
          ...players,
          { name: newPlayerName.trim(), points: 0, history: [{ round: 0, points: 0 }] }
        ]);
        setNewPlayerName('');
      };

      const toggleWinner = (n) => {
        if (losers.includes(n)) return;
        setWinners(winners.includes(n) ? winners.filter(x => x !== n) : [...winners, n]);
      };

      const toggleLoser = (n) => {
        if (winners.includes(n)) return;
        setLosers(losers.includes(n) ? losers.filter(x => x !== n) : [...losers, n]);
      };

      const recordGame = () => {
        const val = parseInt(pointValue);
        if (!val || winners.length === 0 || losers.length === 0) return alert('Gewinner/Verlierer wählen');

        const newPlayers = players.map(p => {
          let change = 0;
          if (gameMode === 'normal') {
            if (winners.includes(p.name)) change = val;
            if (losers.includes(p.name)) change = -val;
          } else {
            if (winners.length === 1 && winners.includes(p.name)) change = val * losers.length;
            else if (winners.length === 1 && losers.includes(p.name)) change = -val;

            if (losers.length === 1 && losers.includes(p.name)) change = -(val * winners.length);
            else if (losers.length === 1 && winners.includes(p.name)) change = val;
          }
          const newPoints = p.points + change;
          return { ...p, points: newPoints, history: [...p.history, { round: gameHistory.length + 1, points: newPoints }] };
        });

        setPlayers(newPlayers);
        setGameHistory([...gameHistory, { winners, losers, val, mode: gameMode }]);
        setWinners([]); setLosers([]);
      };

      const chartData = useMemo(() => {
        return Array.from({ length: gameHistory.length + 1 }, (_, i) => {
          const row = { round: i };
          players.forEach(p => {
            const h = p.history.find(r => r.round === i) || p.history[p.history.length - 1];
            row[p.name] = h?.points ?? 0;
          });
          return row;
        });
      }, [players, gameHistory]);

      if (!window.Recharts) {
        return <div className="flex items-center justify-center h-screen text-slate-400">Initialisiere…</div>;
      }

      const { LineChart, Line, XAxis, YAxis, Tooltip, Legend, CartesianGrid, ResponsiveContainer } = window.Recharts;

      return (
        <div className="max-w-6xl mx-auto p-6 space-y-8">
          <header className="flex justify-between items-center">
            <h1 className="text-4xl font-extrabold tracking-tight text-emerald-400">Schafkopf Pro</h1>
            <button onClick={() => { if (confirm('Alles löschen?')) { localStorage.clear(); location.reload(); } }}
              className="text-sm px-4 py-2 rounded-xl bg-red-500/10 text-red-400 hover:bg-red-500/20">Reset</button>
          </header>

          <section className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="bg-slate-800/70 backdrop-blur rounded-3xl p-6 space-y-4">
              <h2 className="font-bold">Spieler</h2>
              <div className="flex gap-2">
                <input value={newPlayerName} onChange={e => setNewPlayerName(e.target.value)}
                  className="flex-1 bg-slate-900 rounded-xl px-4 py-2" placeholder="Name" />
                <button onClick={addPlayer} className="bg-emerald-600 px-4 rounded-xl font-bold">+</button>
              </div>
              {players.map(p => (
                <div key={p.name} className="flex justify-between bg-slate-900/50 px-4 py-2 rounded-xl">
                  <span>{p.name}</span>
                  <span className={p.points >= 0 ? 'text-emerald-400' : 'text-red-400'}>{(p.points/100).toFixed(2)}€</span>
                </div>
              ))}
            </div>

            <div className="lg:col-span-2 bg-slate-800/70 backdrop-blur rounded-3xl p-6 space-y-6">
              <div className="flex bg-slate-900 rounded-2xl p-1">
                <button onClick={() => setGameMode('normal')} className={`flex-1 py-2 rounded-xl ${gameMode==='normal'?'bg-emerald-600':''}`}>Sauspiel</button>
                <button onClick={() => setGameMode('solo')} className={`flex-1 py-2 rounded-xl ${gameMode==='solo'?'bg-purple-600':''}`}>Solo</button>
              </div>

              <div className="grid grid-cols-2 gap-4">
                {[['Gewinner', winners, toggleWinner, 'emerald'], ['Verlierer', losers, toggleLoser, 'red']].map(([label, list, fn, color]) => (
                  <div key={label} className={`rounded-2xl p-4 bg-${color}-500/5`}>
                    <p className={`text-${color}-400 font-bold text-xs uppercase`}>{label}</p>
                    <div className="flex flex-wrap gap-2 mt-2">
                      {players.map(p => (
                        <button key={p.name} onClick={() => fn(p.name)}
                          className={`px-3 py-1 rounded-xl border ${list.includes(p.name)?`bg-${color}-600 border-${color}-400`:'border-slate-700 text-slate-500'}`}>
                          {p.name}
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>

              <div className="flex gap-4">
                <input type="number" value={pointValue} onChange={e=>setPointValue(e.target.value)}
                  className="w-24 text-center text-xl bg-slate-900 rounded-xl" />
                <button onClick={recordGame} className="flex-1 bg-white text-slate-900 rounded-xl font-bold">Spiel speichern</button>
              </div>
            </div>
          </section>

          {gameHistory.length > 0 && (
            <section className="bg-slate-800/70 rounded-3xl p-6 h-80">
              <ResponsiveContainer width="100%" height={320}>
                <LineChart data={chartData}>
                  <CartesianGrid stroke="#222" strokeDasharray="3 3" />
                  <XAxis dataKey="round" stroke="#555" />
                  <YAxis stroke="#555" />
                  <Tooltip />
                  <Legend />
                  {players.map((p,i)=> (
                    <Line key={p.name} dataKey={p.name} stroke={['#4ade80','#f87171','#60a5fa','#fbbf24','#a78bfa','#f472b6'][i%6]} strokeWidth={3} dot={false} />
                  ))}
                </LineChart>
              </ResponsiveContainer>
            </section>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<SchafkopfApp />);
  </script>
</body>
</html>
